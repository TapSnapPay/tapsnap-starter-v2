{% extends "base.html" %}
{% block content %}
<div class="grid">
  <div class="card">
    <h2 style="margin-top:0">Merchants</h2>
    <form method="post" action="/admin/merchants/new">
      <input required name="name" placeholder="Business name"/>
      <input required name="email" placeholder="Email" type="email"/>
      <button class="btn" type="submit">Create</button>
    </form>
    <table style="margin-top:14px">
     <thead>
  <tr>
    <th>ID</th>
    <th>Name</th>
    <th>Email</th>
    <th>Created</th>
    <th>Actions</th>
  </tr>
</thead>
      <tbody>
      {% for m in merchants %}
        <tr>
  <td>{{ m.id }}</td>
  <td>{{ m.name }}</td>
  <td>{{ m.email }}</td>
  <td class="muted">{{ m.created_at }}</td>
<td>
  <a class="btn" href="/checkout?merchant_id={{ m.id }}&amount=25&currency=USD">Collect $25</a>
  <button type="button" class="btn" style="margin-left:8px"
          onclick="copyLink('/checkout?merchant_id={{ m.id }}&amount=25&currency=USD', this)">
    Copy Pay Link
  </button>
</td>

</tr>
      {% else %}
        <tr><td colspan="4" class="muted">No merchants yet</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2 style="margin-top:0">Recent Transactions</h2>
<h2 style="margin-top:0">Recent Transactions</h2>
<form method="get" action="/admin/" style="margin:10px 0;">
  <label class="muted" style="margin-right:6px;">Status</label>
  <select name="status">
    <option value="" {% if not status %}selected{% endif %}>All</option>
    <option value="authorised" {% if status=='authorised' %}selected{% endif %}>authorised</option>
    <option value="refunded" {% if status=='refunded' %}selected{% endif %}>refunded</option>
    <option value="created" {% if status=='created' %}selected{% endif %}>created</option>
  </select>
  <input type="hidden" name="page" value="1">
  <button class="btn" type="submit" style="margin-left:6px;">Filter</button>
</form>

<form method="get" action="/admin/transactions.csv" style="display:flex; gap:8px; align-items:flex-end; flex-wrap:wrap; margin: 8px 0 12px;">
  <div>
    <label class="muted" style="display:block; font-size:12px;">Start (YYYY-MM-DD)</label>
    <input name="start" type="date" />
  </div>
  <div>
    <label class="muted" style="display:block; font-size:12px;">End (YYYY-MM-DD)</label>
    <input name="end" type="date" />
  </div>
  <div>
    <label class="muted" style="display:block; font-size:12px;">Status</label>
    <select name="status">
      <option value="">Any</option>
      <option value="created">created</option>
      <option value="authorised">authorised</option>
      <option value="refunded">refunded</option>
    </select>
  </div>
  <div>
    <label class="muted" style="display:block; font-size:12px;">Merchant ID</label>
    <input name="merchant_id" type="number" min="1" />
  </div>
  <button class="btn" type="submit">Export CSV</button>
</form>


<table style="margin-top:10px">
  <thead>
    <tr>
      <th>ID</th>
      <th>Merchant</th>
      <th>Amount</th>
      <th>Currency</th>
      <th>Status</th>
      <th>PSP Ref</th>
      <th>Created</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for tx in txs %}
    <tr>
      <td>{{ tx.id }}</td>
      <td>{{ tx.merchant_id }}</td>
      <td>${{ '%.2f'|format(tx.amount_cents / 100) }}</td>
      <td>{{ tx.currency }}</td>
      <td>{{ tx.status }}</td>
      <td class="muted">{{ tx.psp_reference or '-' }}</td>
      <td class="muted">{{ tx.created_at }}</td>
      <td>
        {% if tx.status != 'refunded' %}
          <form method="post" action="/admin/transactions/{{ tx.id }}/refund" style="display:inline">
            <button type="submit">Refund</button>
          </form>
        {% else %}
          <span class="muted">â€”</span>
        {% endif %}
      </td>
    </tr>
  {% else %}
    <tr>
      <td colspan="8" class="muted">No transactions yet</td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</table>

<div style="margin-top:12px;">
  {% if has_prev %}
    <a class="btn" href="/admin/?page={{ page-1 }}{% if status %}&status={{ status }}{% endif %}">Prev</a>
  {% else %}
    <span class="btn muted" style="opacity:.5; pointer-events:none;">Prev</span>
  {% endif %}

  <span class="muted" style="margin:0 8px;">Page {{ page }} of {{ pages }}</span>

  {% if has_next %}
    <a class="btn" href="/admin/?page={{ page+1 }}{% if status %}&status={{ status }}{% endif %}">Next</a>
  {% else %}
    <span class="btn muted" style="opacity:.5; pointer-events:none;">Next</span>
  {% endif %}
</div>

<script>
  async function copyLink(url, btn) {
    try {
      await navigator.clipboard.writeText(window.location.origin + url);
      const old = btn.textContent;
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = old; }, 1200);
    } catch (e) {
      alert('Could not copy. Here is the link:\n' + window.location.origin + url);
    }
  }
</script>

{% endblock %}