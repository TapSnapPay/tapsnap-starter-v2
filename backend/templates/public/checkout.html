{% extends "base.html" %}
{% block content %}
<h2>Checkout</h2>

<form id="checkoutForm" style="max-width:420px; display:grid; gap:10px;">
  <label>
    Merchant ID
    <input id="merchantId" type="number" required />
  </label>

  <label>
    Amount (USD $)
    <input id="amount" type="number" step="0.01" min="0.01" required />
  </label>

  <label>
    Currency
    <input id="currency" type="text" value="USD" required />
  </label>

  <button type="submit">Pay</button>
</form>

<script>
  const form = document.getElementById('checkoutForm');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const merchant_id = parseInt(document.getElementById('merchantId').value, 10);
    const dollars = parseFloat(document.getElementById('amount').value);
    const amount_cents = Math.round(dollars * 100); // $30.00 -> 3000
    const currency = document.getElementById('currency').value.trim().toUpperCase();

    try {
      const res = await fetch('/api/v1/transactions/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ merchant_id, amount_cents, currency })
      });

      if (!res.ok) {
        const text = await res.text();
        alert('Create failed: ' + res.status + ' ' + text);
        return;
      }

      const tx = await res.json();
      // Go to success page and show the new transaction
      window.location.href = '/success?tx_id=' + tx.id;
    } catch (err) {
      alert('Network error: ' + err.message);
    }
  });
</script>
{% endblock %}
